LOAD DATABASE
    FROM mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DB}?useSSL=true
    INTO postgresql://${PG_USER}:endpoint=${PG_ENDPOINT_ID};${PG_PASSWORD}@${PG_ENDPOINT_ID}.${PG_REGION}.aws.neon.tech/${PG_DB}?sslmode=require

WITH
    truncate,
    batch rows = 1000,
    batch size = 20MB,
    workers = 2,
    concurrency = 1

SET MySQL PARAMETERS
    time_zone = 'UTC'

SET PostgreSQL PARAMETERS
    timezone to 'UTC'

INCLUDING ONLY TABLE NAMES MATCHING ~/^pipeline$/
-- EXCLUDING TABLE NAMES MATCHING ~/^text_content$/, ~/^dbpass_upsert_record$/

-- 表过滤条件（由脚本动态添加）

CAST
    type datetime to timestamp,
    type json to jsonb,
    
    -- ============================================================================
    -- 毫秒级 bigint 时间戳转换为 timestamptz
    -- 使用自定义函数: unix-timestamp-ms-to-timestamptz (0/-1 转为 NULL)
    -- 使用自定义函数: unix-timestamp-ms-to-timestamptz-allow-zero (0 保留为 1970-01-01)
    -- 运行命令: pgloader --load-lisp-file ms-transforms.lisp config.load
    -- ============================================================================
    
    -- chat_session
    column chat_session.deleted_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column chat_session.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column chat_session.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline (heartbeat_ts 保持 bigint)
    column pipeline.start_process_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    column pipeline.end_process_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    column pipeline.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_result_event
    column pipeline_result_event.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_step (duration 保持 bigint，表示时间长度)
    column pipeline_step.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- project
    column project.deleted_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column project.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column project.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- project_data
    column project_data.deleted_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column project_data.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- project_github_repo_binding
    column project_github_repo_binding.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column project_github_repo_binding.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- project_index
    column project_index.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column project_index.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- project_index_v2
    column project_index_v2.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column project_index_v2.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- user_github_installation
    column user_github_installation.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column user_github_installation.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- user_third_party_auth
    column user_third_party_auth.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column user_third_party_auth.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- gitea_backup_tasks
    column gitea_backup_tasks.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- fulfill_ai_credit_change_log
    column fulfill_ai_credit_change_log.op_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- fulfill_ai_credit_usage_log
    column fulfill_ai_credit_usage_log.op_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- fulfill_ai_credit
    column fulfill_ai_credit.start_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    column fulfill_ai_credit.end_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- fulfill_ai_free_credit_distribution_log
    column fulfill_ai_free_credit_distribution_log.begin_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- stripe_subscription
    column stripe_subscription.start_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    column stripe_subscription.current_period_start to timestamptz using unix-timestamp-ms-to-timestamptz,
    column stripe_subscription.current_period_end to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- user_account_delete_record (0 表示未删除，需要保留 0 -> 1970-01-01)
    column user_account_delete_record.delete_marker to timestamptz using unix-timestamp-ms-to-timestamptz-allow-zero,
    
    -- pipeline_v2
    column pipeline_v2.created_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_result_snippet
    column pipeline_result_snippet.generated_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    column pipeline_result_snippet.created_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_event
    column pipeline_event.generated_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    column pipeline_event.created_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_feedback
    column pipeline_feedback.feedback_at to timestamptz using unix-timestamp-ms-to-timestamptz

