LOAD DATABASE
    FROM mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DB}?useSSL=true
    INTO postgresql://${PG_USER}:endpoint=${PG_ENDPOINT_ID};${PG_PASSWORD}@${PG_ENDPOINT_ID}.${PG_REGION}.aws.neon.tech/${PG_DB}?sslmode=require

WITH
    truncate,
    batch rows = 1000,
    batch size = 20MB,
    workers = 2,
    concurrency = 1

SET MySQL PARAMETERS
    time_zone = 'UTC'

SET PostgreSQL PARAMETERS
    timezone to 'UTC'

INCLUDING ONLY TABLE NAMES MATCHING ~/^stripe_subscription$/

-- 表过滤条件（由脚本动态添加）

CAST
    type json to jsonb,
    
    -- ============================================================================
    -- 毫秒级 bigint 时间戳转换为 timestamptz
    -- 仅转换没有默认值的字段（这些字段插入时必有有效值，不会是 0/-1）
    -- 使用自定义函数: unix-timestamp-ms-to-timestamptz
    -- 运行命令: pgloader --load-lisp-file ms-transforms.lisp config.load
    -- ============================================================================
    
    -- project_index (created_ts: 无默认值)
    column project_index.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- project_index_v2 (created_ts/updated_ts: 无默认值)
    column project_index_v2.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column project_index_v2.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- user_third_party_auth (created_ts/updated_ts: 无默认值)
    column user_third_party_auth.created_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    column user_third_party_auth.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- gitea_backup_tasks (updated_ts: 无默认值)
    column gitea_backup_tasks.updated_ts to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- fulfill_ai_credit_change_log (op_time: 无默认值)
    column fulfill_ai_credit_change_log.op_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- fulfill_ai_credit_usage_log (op_time: 无默认值)
    column fulfill_ai_credit_usage_log.op_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- fulfill_ai_credit (start_time/end_time: 无默认值)
    column fulfill_ai_credit.start_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    column fulfill_ai_credit.end_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- fulfill_ai_free_credit_distribution_log (begin_time: 无默认值)
    column fulfill_ai_free_credit_distribution_log.begin_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- stripe_subscription (start_time/current_period_start/current_period_end: 无默认值)
    column stripe_subscription.start_time to timestamptz using unix-timestamp-ms-to-timestamptz,
    column stripe_subscription.current_period_start to timestamptz using unix-timestamp-ms-to-timestamptz,
    column stripe_subscription.current_period_end to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_v2 (created_at: 无默认值)
    column pipeline_v2.created_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_result_snippet (generated_at/created_at: 无默认值)
    column pipeline_result_snippet.generated_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    column pipeline_result_snippet.created_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_event (generated_at/created_at: 无默认值)
    column pipeline_event.generated_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    column pipeline_event.created_at to timestamptz using unix-timestamp-ms-to-timestamptz,
    
    -- pipeline_feedback (feedback_at: 无默认值)
    column pipeline_feedback.feedback_at to timestamptz using unix-timestamp-ms-to-timestamptz
;
